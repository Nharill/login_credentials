<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
        }
        .container-center {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        .password-container {
            position: relative;
        }
        .toggle-password {
            position: absolute;
            right: 1rem;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            color: #9ca3af;
        }
        /* Custom styles for table layout */
        .table-container {
            overflow-x: auto;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1-px rgba(0, 0, 0, 0.06);
        }
        .table-container table {
            min-width: 100%;
            border-collapse: collapse;
        }
        .table-container thead th {
            text-align: left;
            padding: 1rem;
            font-size: 0.875rem;
            font-weight: 700;
            color: #4a5568;
            background-color: #e2e8f0;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .table-container tbody tr {
            transition: all 0.2s ease-in-out;
        }
        .table-container tbody tr.main-row:hover {
            background-color: #f7fafc;
        }
        .table-container tbody td {
            padding: 1rem;
            font-size: 0.875rem;
            color: #4a5568;
            border-bottom: 1px solid #e2e8f0;
        }
        .table-container tbody tr:last-child td {
            border-bottom: none;
        }
        .editable-field {
            min-width: 120px;
            padding: 0.25rem 0.5rem;
            border: 1px solid transparent;
            border-radius: 0.25rem;
            transition: all 0.2s;
        }
        .editable-field:hover {
            background-color: #e2e8f0;
        }
        .editable-field:focus {
            outline: none;
            border-color: #3b82f6;
            background-color: #ffffff;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Login Modal/Container -->
    <div id="loginContainer" class="container-center">
        <div class="bg-white rounded-3xl shadow-2xl p-12 max-w-lg w-full transform transition-all duration-300 scale-100">
            <div class="text-center mb-8">
                <div class="w-20 h-20 bg-blue-600 rounded-full flex items-center justify-center mx-auto mb-4 animate-bounce-slow">
                    <span class="text-white text-4xl">🔑</span>
                </div>
                <h1 class="text-3xl font-bold text-gray-900 mb-2">Admin Login</h1>
                <p class="text-gray-500">Enter the admin credentials to access the dashboard.</p>
            </div>
            <form id="loginForm" class="space-y-6">
                <div>
                    <label for="adminEmail" class="block text-sm font-medium text-gray-700">Email Address</label>
                    <input type="email" id="adminEmail" placeholder="Enter your email" required
                           class="mt-1 block w-full px-5 py-3 bg-gray-50 border border-gray-300 rounded-xl shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors duration-200">
                </div>
                <div class="password-container">
                    <label for="adminPassword" class="block text-sm font-medium text-gray-700">Password</label>
                    <input type="password" id="adminPassword" placeholder="Enter password" required
                           class="mt-1 block w-full pr-12 pl-5 py-3 bg-gray-50 border border-gray-300 rounded-xl shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors duration-200">
                    <span class="toggle-password" id="togglePassword">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" id="eye-open">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                        </svg>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor" id="eye-closed">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.25a2.625 2.625 0 11-5.25 0 2.625 2.625 0 015.25 0z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.5 12a1.5 1.5 0 110-3 1.5 1.5 0 010 3z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                        </svg>
                    </span>
                </div>
                <button type="submit"
                        class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-4 px-6 rounded-xl transition-all duration-300 transform hover:scale-105 shadow-lg">
                    Log In
                </button>
            </form>
            <div id="loginError" class="mt-4 text-center text-red-500 font-semibold" style="display:none;">
                Incorrect email or password. Please try again.
            </div>
        </div>
    </div>

    <!-- Admin Dashboard (Hidden by default) -->
    <div id="dashboardContainer" class="hidden min-h-screen bg-gray-100">
        <!-- Header -->
        <div class="bg-white shadow-lg border-b-4 border-blue-600">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center py-6">
                    <div class="flex items-center space-x-4">
                        <div class="w-12 h-12 bg-blue-600 rounded-lg flex items-center justify-center">
                            <span class="text-white text-2xl">📊</span>
                        </div>
                        <div>
                            <h1 class="text-2xl font-bold text-gray-900">Admin Dashboard</h1>
                            <p class="text-sm text-gray-500">Real-time Inspection Request Management</p>
                            <p class="text-sm text-gray-500">Admin User ID: <span id="adminUserId" class="font-mono text-xs"></span></p>
                        </div>
                    </div>
                    <button id="logoutButton"
                            class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-xl transition-colors duration-200 shadow-md">
                        Log Out
                    </button>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="text-left mb-8 flex items-center">
                <img src="https://www.pup.edu.ph/resources/images/logo200.png" alt="PUP Logo" class="w-20 h-20 mr-6">
                <div>
                    <p class="text-xs font-semibold text-gray-600">Republic of the Philippines</p>
                    <p class="text-sm font-semibold text-gray-800">Polytechnic University of the Philippines</p>
                    <p class="text-base font-bold text-gray-900">OFFICE OF EXECUTIVE VICE PRESIDENT</p>
                    <p class="text-lg font-bold text-gray-900">Inspection Management Office</p>
                </div>
            </div>
            <div class="text-center mb-8">
                <h2 class="text-3xl font-bold text-gray-900">INSPECTION MONITORING REPORT</h2>
                <p class="text-xl font-bold text-gray-800 mt-2">OPERATIONS PURCHASE</p>
                <p id="dateRangeDisplay" class="text-lg font-semibold text-gray-700 mt-2 cursor-pointer">AS OF: July 2 - September 20, 2025</p>
                <div id="dateFilterControls" class="mt-4 flex flex-col sm:flex-row items-center justify-center space-y-4 sm:space-y-0 sm:space-x-4 hidden">
                    <span class="font-bold text-gray-700">Filter by Date:</span>
                    <div class="flex items-center space-x-2">
                        <label for="startDate" class="sr-only">Start Date</label>
                        <input type="date" id="startDate" class="px-4 py-2 border rounded-lg shadow-sm" value="2025-07-02">
                        <span>to</span>
                        <label for="endDate" class="sr-only">End Date</label>
                        <input type="date" id="endDate" class="px-4 py-2 border rounded-lg shadow-sm" value="2025-09-20">
                    </div>
                    <button id="applyFilterBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-xl transition-colors duration-200 shadow-md">
                        Apply
                    </button>
                </div>
            </div>
            
            <div id="formsLoading" class="text-center py-12 text-gray-500">
                <svg class="animate-spin h-10 w-10 text-blue-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.962l3-2.671z"></path>
                </svg>
                <p class="mt-4">Loading forms...</p>
            </div>
            
            <div class="flex justify-end mb-4">
                <button id="exportCsvBtn" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-xl transition-colors duration-200 shadow-md">
                    Export to CSV
                </button>
            </div>
            
            <div id="formsContainer" class="table-container bg-white">
                <table class="w-full">
                    <thead>
                        <tr>
                            <th class="px-6 py-3">No.</th>
                            <th class="px-6 py-3">Control Number</th>
                            <th class="px-6 py-3">Date and Time Requested</th>
                            <th class="px-6 py-3">Date and Time Inspected</th>
                            <th class="px-6 py-3">Office/Department</th>
                            <th class="px-6 py-3">Requested By</th>
                            <th class="px-6 py-3">Disbursing Officer</th>
                            <th class="px-6 py-3">Purpose</th>
                            <th class="px-6 py-3">Particulars</th>
                            <th class="px-6 py-3">Category</th>
                            <th class="px-6 py-3">Cost</th>
                            <th class="px-6 py-3">Inspected By</th>
                            <th class="px-6 py-3">Status</th>
                            <th class="px-6 py-3">No. of Days</th>
                            <th class="px-6 py-3">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="formsTableBody">
                        <!-- Table rows will be inserted here dynamically -->
                    </tbody>
                </table>
            </div>
            
            <div id="noFormsMessage" class="hidden text-center py-12 text-gray-500">
                <p class="text-xl">No inspection requests have been submitted yet.</p>
            </div>
        </div>
    </div>
    
    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-[9999] hidden">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md mx-4 p-8 text-center space-y-6">
            <h3 class="text-2xl font-bold text-gray-900">Confirm Deletion</h3>
            <p class="text-gray-700">Are you sure you want to delete this inspection request? This action cannot be undone.</p>
            <div class="flex justify-center space-x-4">
                <button id="cancelDeleteBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-6 rounded-xl transition-colors duration-200">
                    Cancel
                </button>
                <button id="confirmDeleteBtn" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-6 rounded-xl transition-colors duration-200">
                    Delete</button>
            </div>
        </div>
    </div>
    
    <!-- Modal for Firebase Auth Error -->
    <div id="firebaseAuthErrorModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-[9999]" style="display: none;">
        <div class="bg-white rounded-2xl shadow-2xl max-w-xl mx-4 p-8 text-center">
            <h2 class="text-2xl font-bold text-red-600 mb-4">Authentication Error</h2>
            <p class="text-lg text-gray-700">
                Anonymous sign-in failed. This is likely because the Anonymous sign-in provider is not enabled in your Firebase project.
            </p>
            <p class="mt-4 text-sm text-gray-600">
                To fix this, please follow these steps:
            </p>
            <ol class="list-decimal list-inside text-left mt-4 text-sm text-gray-700 space-y-2">
                <li>Go to your Firebase project console.</li>
                <li>Navigate to **Authentication** in the Build menu.</li>
                <li>Go to the **Sign-in method** tab.</li>
                <li>Find the **Anonymous** provider and click the pencil icon to edit it.</li>
                <li>Enable the provider and save your changes.</li>
            </ol>
            <button id="closeFirebaseAuthErrorModal" class="mt-8 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-xl transition-all duration-300 transform hover:scale-105 shadow-md">
                I Understand
            </button>
        </div>
    </div>
    
    <!-- New Modal for Firestore API Error -->
    <div id="firestoreApiErrorModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-[9999]" style="display: none;">
        <div class="bg-white rounded-2xl shadow-2xl max-w-xl mx-4 p-8 text-center">
            <h2 class="text-2xl font-bold text-red-600 mb-4">Firestore API Disabled</h2>
            <p class="text-lg text-gray-700">
                The Cloud Firestore API is not enabled for your project.
            </p>
            <p class="mt-4 text-sm text-gray-600">
                To fix this, please follow these steps:
            </p>
            <ol class="list-decimal list-inside text-left mt-4 text-sm text-gray-700 space-y-2">
                <li>Go to your Google Cloud Console.</li>
                <li>Visit the <a href="https://console.developers.google.com/apis/api/firestore.googleapis.com/overview?project=${firebaseConfig.projectId}" target="_blank" class="text-blue-600 underline">Firestore API page</a> for your project.</li>
                <li>Click the **Enable** button.</li>
                <li>Wait a few minutes for the changes to take effect, then reload this page.</li>
            </ol>
            <button id="closeFirestoreApiErrorModal" class="mt-8 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-xl transition-all duration-300 transform hover:scale-105 shadow-md">
                I Understand
            </button>
        </div>
    </div>
    
    <!-- New Modal for Firestore Database Missing Error -->
    <div id="firestoreDatabaseErrorModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-[9999]" style="display: none;">
        <div class="bg-white rounded-2xl shadow-2xl max-w-xl mx-4 p-8 text-center">
            <h2 class="text-2xl font-bold text-red-600 mb-4">Database Not Found</h2>
            <p class="text-lg text-gray-700">
                The Firestore database has not been created for your project.
            </p>
            <p class="mt-4 text-sm text-gray-600">
                To fix this, please follow these steps:
            </p>
            <ol class="list-decimal list-inside text-left mt-4 text-sm text-gray-700 space-y-2">
                <li>Go to your Firebase project console.</li>
                <li>Navigate to **Firestore Database** in the Build menu.</li>
                <li>Click the **Create database** button.</li>
                <li>Choose "Start in production mode" or "Start in test mode" and follow the prompts.</li>
                <li>Once the database is created, reload this page.</li>
            </ol>
            <button id="closeFirestoreDatabaseErrorModal" class="mt-8 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-xl transition-all duration-300 transform hover:scale-105 shadow-md">
                I Understand
            </button>
        </div>
    </div>

    <!-- New Modal for Firestore Permission Denied Error -->
    <div id="firestorePermissionDeniedModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-[9999]" style="display: none;">
        <div class="bg-white rounded-2xl shadow-2xl max-w-xl mx-4 p-8 text-center">
            <h2 class="text-2xl font-bold text-red-600 mb-4">Access Denied</h2>
            <p class="text-lg text-gray-700">
                Permission to access the Firestore database was denied. This is likely due to incorrect security rules.
            </p>
            <p class="mt-4 text-sm text-gray-600">
                To fix this, you need to set up your security rules to allow public read access for the relevant collection.
            </p>
            <p class="mt-4 text-sm text-gray-600">
                Please also make sure the `inspectionForms` collection and its documents have public read access.
            </p>
            <ol class="list-decimal list-inside text-left mt-4 text-sm text-gray-700 space-y-2">
                <li>Go to your Firebase project console.</li>
                <li>Navigate to **Firestore Database** in the Build menu.</li>
                <li>Go to the **Rules** tab.</li>
                <li>Replace the default rules with the following public access rules:
                    <pre class="bg-gray-100 p-2 rounded-lg mt-2 text-xs overflow-x-auto"><code>rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /artifacts/{appId}/public/data/{document=**} {
      allow read: if true;
    }
  }
}</code></pre>
                </li>
                <li>Click **Publish** to save the changes.</li>
            </ol>
            <button id="closeFirestorePermissionDeniedModal" class="mt-8 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-xl transition-all duration-300 transform hover:scale-105 shadow-md">
                I Understand
            </button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase configuration from the main app
        const firebaseConfig = {
            apiKey: "AIzaSyDXdIjYRCjwl6zFSKAbv-Pc_FI7xQLX1WA",
            authDomain: "inspect-128d0.firebaseapp.com",
            projectId: "inspect-128d0",
            storageBucket: "inspect-128d0.firebasestorage.app",
            messagingSenderId: "989001816031",
            appId: "1:989001816031:web:57671f84e3bca0301a566a",
            measurementId: "G-CN4XLNZWVD"
        };
        
        const appId = firebaseConfig.projectId;
        let db;
        let auth;
        const ADMIN_EMAIL = "admin@pup.edu.ph";
        const ADMIN_PASSWORD = "IMOADMIN_2025";

        document.addEventListener('DOMContentLoaded', function() {
            initializeFirebase();

            document.getElementById('loginForm').addEventListener('submit', function(event) {
                event.preventDefault();
                const email = document.getElementById('adminEmail').value;
                const password = document.getElementById('adminPassword').value;
                const loginError = document.getElementById('loginError');

                if (email === ADMIN_EMAIL && password === ADMIN_PASSWORD) {
                    loginError.style.display = 'none';
                    document.getElementById('loginContainer').classList.add('hidden');
                    document.getElementById('dashboardContainer').classList.remove('hidden');
                    loadDashboardData();
                } else {
                    loginError.style.display = 'block';
                }
            });

            document.getElementById('logoutButton').addEventListener('click', function() {
                document.getElementById('dashboardContainer').classList.add('hidden');
                document.getElementById('loginContainer').classList.remove('hidden');
                document.getElementById('adminEmail').value = '';
                document.getElementById('adminPassword').value = '';
                document.getElementById('formsTableBody').innerHTML = '';
            });
            
            document.getElementById('togglePassword').addEventListener('click', function() {
                const passwordInput = document.getElementById('adminPassword');
                const eyeOpen = document.getElementById('eye-open');
                const eyeClosed = document.getElementById('eye-closed');
                
                const isPasswordVisible = passwordInput.getAttribute('type') === 'text';
                
                if (isPasswordVisible) {
                    passwordInput.setAttribute('type', 'password');
                    eyeOpen.classList.remove('hidden');
                    eyeClosed.classList.add('hidden');
                } else {
                    passwordInput.setAttribute('type', 'text');
                    eyeOpen.classList.add('hidden');
                    eyeClosed.classList.remove('hidden');
                }
            });

            document.getElementById('closeFirebaseAuthErrorModal').addEventListener('click', () => {
                document.getElementById('firebaseAuthErrorModal').style.display = 'none';
            });
            document.getElementById('closeFirestoreApiErrorModal').addEventListener('click', () => {
                document.getElementById('firestoreApiErrorModal').style.display = 'none';
            });
            document.getElementById('closeFirestoreDatabaseErrorModal').addEventListener('click', () => {
                document.getElementById('firestoreDatabaseErrorModal').style.display = 'none';
            });
            document.getElementById('closeFirestorePermissionDeniedModal').addEventListener('click', () => {
                document.getElementById('firestorePermissionDeniedModal').style.display = 'none';
            });
            
            // Delete modal event listeners
            document.getElementById('cancelDeleteBtn').addEventListener('click', () => {
                document.getElementById('deleteModal').classList.add('hidden');
            });
            
            // Toggle visibility of date filter controls
            document.getElementById('dateRangeDisplay').addEventListener('click', () => {
                document.getElementById('dateFilterControls').classList.toggle('hidden');
            });

            document.getElementById('applyFilterBtn').addEventListener('click', () => {
                loadDashboardData();
                document.getElementById('dateFilterControls').classList.add('hidden');
            });

            document.getElementById('exportCsvBtn').addEventListener('click', exportToCsv);
        });

        async function initializeFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                auth.onAuthStateChanged((user) => {
                    if (user) {
                        document.getElementById('adminUserId').textContent = user.uid;
                    } else {
                        signInAnonymously(auth).catch((error) => {
                            console.error("Anonymous sign-in failed:", error);
                            document.getElementById('firebaseAuthErrorModal').style.display = 'flex';
                        });
                    }
                });
            } catch (error) {
                console.error("Error initializing Firebase:", error);
                if (error.message.includes('firestore.googleapis.com')) {
                    document.getElementById('firestoreApiErrorModal').style.display = 'flex';
                } else if (error.message.includes('The database (default) does not exist')) {
                    document.getElementById('firestoreDatabaseErrorModal').style.display = 'flex';
                } else {
                     let messageBox = document.createElement('div');
                     messageBox.innerHTML = `
                         <div class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-[9999]">
                             <div class="bg-white rounded-lg p-6 shadow-xl max-w-sm mx-auto">
                                 <div class="flex items-center space-x-4 mb-4">
                                     <span class="text-red-500 text-2xl">⚠️</span>
                                     <h3 class="text-lg font-bold">Initialization Error</h3>
                                 </div>
                                 <p class="text-sm text-gray-700">
                                     The app could not connect to Firebase. Please check your browser's console for more details.
                                 </p>
                                 <div class="flex justify-end mt-6">
                                     <button onclick="this.closest('.fixed').remove()" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold px-4 py-2 rounded-lg transition-colors">
                                         OK
                                     </button>
                                 </div>
                             </div>
                         </div>
                     `;
                     document.body.appendChild(messageBox);
                }
            }
        }

        function loadDashboardData() {
            const formsContainer = document.getElementById('formsContainer');
            const formsTableBody = document.getElementById('formsTableBody');
            const loadingIndicator = document.getElementById('formsLoading');
            const noFormsMessage = document.getElementById('noFormsMessage');

            loadingIndicator.classList.remove('hidden');
            formsTableBody.innerHTML = '';
            formsContainer.classList.add('hidden');
            noFormsMessage.classList.add('hidden');
            
            if (!db) {
                console.error("Firestore not initialized.");
                loadingIndicator.classList.add('hidden');
                noFormsMessage.textContent = "Error: Could not connect to Firestore.";
                noFormsMessage.classList.remove('hidden');
                return;
            }

            const formsCollection = collection(db, `/artifacts/${appId}/public/data/inspectionForms`);
            
            onSnapshot(formsCollection, (snapshot) => {
                loadingIndicator.classList.add('hidden');
                formsTableBody.innerHTML = '';
                
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;
                
                // Update the date range display text
                const dateRangeDisplay = document.getElementById('dateRangeDisplay');
                if (startDate && endDate) {
                    const start = new Date(startDate);
                    const end = new Date(endDate);
                    const options = { month: 'long', day: 'numeric', year: 'numeric' };
                    dateRangeDisplay.textContent = `AS OF: ${start.toLocaleDateString('en-US', { month: 'long', day: 'numeric' })} - ${end.toLocaleDateString('en-US', options)}`;
                } else {
                    dateRangeDisplay.textContent = `AS OF: All Dates`;
                }

                const filteredDocs = snapshot.docs.filter(doc => {
                    const data = doc.data();
                    if (!data.timestamp) return false;
                    
                    const requestDate = new Date(data.timestamp.split(',')[0]).getTime();
                    
                    const startTimestamp = startDate ? new Date(startDate).getTime() : 0;
                    const endTimestamp = endDate ? new Date(endDate).getTime() : Infinity;

                    // The original code was missing 1 day for the end date filter, so adding it here
                    const adjustedEndTimestamp = endDate ? endTimestamp + (24 * 60 * 60 * 1000) : Infinity;

                    return requestDate >= startTimestamp && requestDate < adjustedEndTimestamp;
                });

                if (filteredDocs.length === 0) {
                    noFormsMessage.classList.remove('hidden');
                    formsContainer.classList.add('hidden');
                } else {
                    noFormsMessage.classList.add('hidden');
                    formsContainer.classList.remove('hidden');
                    let i = 1;
                    filteredDocs.forEach((doc) => {
                        const data = doc.data();
                        const formRow = createFormRow(i++, doc.id, data);
                        formsTableBody.appendChild(formRow);
                    });
                }
            }, (error) => {
                console.error("Error fetching documents:", error);
                loadingIndicator.classList.add('hidden');
                if (error.code === 'permission-denied') {
                    document.getElementById('firestorePermissionDeniedModal').style.display = 'flex';
                }
            });
        }
        
        function calculateDays(requestedDate, inspectedDate) {
            if (!requestedDate || !inspectedDate) {
                return 'N/A';
            }
            try {
                const oneDay = 1000 * 60 * 60 * 24;
                const requestTimestamp = new Date(requestedDate).getTime();
                const inspectTimestamp = new Date(inspectedDate).getTime();

                if (isNaN(requestTimestamp) || isNaN(inspectTimestamp)) {
                    return 'N/A';
                }

                const differenceInMs = inspectTimestamp - requestTimestamp;
                const differenceInDays = Math.ceil(differenceInMs / oneDay);
                
                return Math.max(1, differenceInDays) + ' day(s)';
            } catch (e) {
                console.error("Error calculating days:", e);
                return 'N/A';
            }
        }

        function createFormRow(number, docId, data) {
            const rowFragment = document.createDocumentFragment();
            const categoryText = data.category === 'Others' ? `${data.category} (${data.categoryOthersText})` : data.category || 'N/A';
            const formattedCost = data.totalAmount ? `₱${parseFloat(data.totalAmount).toLocaleString('en-PH', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}` : 'N/A';
            const inspectedBy = data.inspectedBy || '';
            const status = data.status || 'PENDING';
            const numberOfDays = calculateDays(data.timestamp, data.inspectedDate);

            const mainRow = document.createElement('tr');
            mainRow.className = 'main-row';
            mainRow.innerHTML = `
                <td class="px-6 py-4">${number}</td>
                <td class="px-6 py-4">${data.controlNumber || 'N/A'}</td>
                <td class="px-6 py-4">${data.timestamp || 'N/A'}</td>
                <td class="px-6 py-4">
                    <span id="inspectedDate-${docId}"
                          class="editable-field"
                          contenteditable="true"
                          placeholder="Enter Date">
                        ${data.inspectedDate || ''}
                    </span>
                </td>
                <td class="px-6 py-4">${data.officeDepartment || 'N/A'}</td>
                <td class="px-6 py-4">${data.requestedBy || 'N/A'}</td>
                <td class="px-6 py-4">${data.disbursingOfficer || 'N/A'}</td>
                <td class="px-6 py-4">${data.purpose || 'N/A'}</td>
                <td class="px-6 py-4">${data.particulars || 'N/A'}</td>
                <td class="px-6 py-4">${categoryText}</td>
                <td class="px-6 py-4">${formattedCost}</td>
                <td class="px-6 py-4">
                    <select id="inspectedBy-${docId}"
                            class="editable-field"
                            onchange="updateInspectedBy('${docId}', this.value)">
                        <option value="" ${inspectedBy === '' ? 'selected' : ''}>Select Inspector</option>
                        <option value="DIR. FERDINAND O. NATIVIDAD" ${inspectedBy === 'DIR. FERDINAND O. NATIVIDAD' ? 'selected' : ''}>DIR. FERDINAND O. NATIVIDAD</option>
                        <option value="CH. JONATHAN C. MANARANG" ${inspectedBy === 'CH. JONATHAN C. MANARANG' ? 'selected' : ''}>CH. JONATHAN C. MANARANG</option>
                        <option value="INS. CARMELO T. OSORIO JR." ${inspectedBy === 'INS. CARMELO T. OSORIO JR.' ? 'selected' : ''}>INS. CARMELO T. OSORIO JR.</option>
                        <option value="INS. ARA DIETHER LEI Y. DE CHAVEZ" ${inspectedBy === 'INS. ARA DIETHER LEI Y. DE CHAVEZ' ? 'selected' : ''}>INS. ARA DIETHER LEI Y. DE CHAVEZ</option>
                    </select>
                </td>
                <td class="px-6 py-4">
                    <select id="status-${docId}"
                            class="editable-field"
                            onchange="updateStatus('${docId}', this.value)">
                        <option value="PENDING" ${status === 'PENDING' ? 'selected' : ''}>PENDING</option>
                        <option value="COMPLIED" ${status === 'COMPLIED' ? 'selected' : ''}>COMPLIED</option>
                        <option value="NOT COMPLIED" ${status === 'NOT COMPLIED' ? 'selected' : ''}>NOT COMPLIED</option>
                    </select>
                </td>
                <td class="px-6 py-4" id="days-${docId}">${numberOfDays}</td>
                <td class="px-6 py-4 flex items-center space-x-2">
                    <button onclick="toggleDetails('${docId}')" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-1 px-3 rounded-full text-xs transition-colors duration-200">View</button>
                    <button onclick="confirmDelete('${docId}')" class="bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-3 rounded-full text-xs transition-colors duration-200">Delete</button>
                </td>
            `;
            
            const detailRow = document.createElement('tr');
            detailRow.id = `details-row-${docId}`;
            detailRow.className = 'detail-row hidden';
            detailRow.innerHTML = `
                <td colspan="15" class="p-6 bg-gray-50 border-t border-gray-200">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm text-gray-700 mb-4">
                        <div>
                            <p><strong>Type:</strong> 
                                <span class="px-2 py-1 text-xs font-semibold rounded-full ${getPurchaseTypeColor(data.purchaseType)}">
                                    ${getPurchaseTypeLabel(data.purchaseType)}
                                </span>
                            </p>
                            <p><strong>Contact Number:</strong> ${data.contactNumber || 'N/A'}</p>
                            <p><strong>Email:</strong> ${data.institutionalEmail || 'N/A'}</p>
                            <p><strong>Disbursing Officer:</strong> ${data.disbursingOfficer || 'N/A'}</p>
                            <p><strong>Sector:</strong> ${data.sector || 'N/A'}</p>
                            <p><strong>User ID:</strong> <span class="font-mono">${data.userId || 'N/A'}</span></p>
                        </div>
                        <div>
                            <p><strong>Purpose:</strong> ${data.purpose || 'N/A'}</p>
                            <p><strong>Particulars:</strong> ${data.particulars || 'N/A'}</p>
                            <p><strong>Total Amount:</strong> ${formattedCost}</p>
                            ${data.category ? `<p><strong>Category:</strong> ${data.category}${data.categoryOthersText ? ` (${data.categoryOthersText})` : ''}</p>` : ''}
                            <p><strong>Documentary Requirements:</strong></p>
                            <ul class="list-disc list-inside ml-4">
                                ${Array.isArray(data.documentaryRequirement) ? data.documentaryRequirement.map(req => `<li>${getRequirementLabel(req)}</li>`).join('') : '<li>None specified</li>'}
                                ${data.othersText ? `<li>Others: ${data.othersText}</li>` : ''}
                            </ul>
                        </div>
                    </div>
                    <div class="mt-4">
                        <p class="font-bold mb-2">Remarks:</p>
                        <textarea id="remarks-${docId}"
                                  class="w-full h-24 p-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                  placeholder="Add remarks here..."
                                  onblur="updateRemarks('${docId}', this.value)">${data.remarks || ''}</textarea>
                    </div>
                </td>
            `;

            rowFragment.appendChild(mainRow);
            rowFragment.appendChild(detailRow);
            
            const inspectedDateElement = mainRow.querySelector(`#inspectedDate-${docId}`);
            if (inspectedDateElement) {
                inspectedDateElement.addEventListener('blur', (e) => {
                    const newDate = e.target.textContent;
                    updateInspectedDate(docId, newDate);
                    // Re-calculate days after update
                    const daysElement = document.getElementById(`days-${docId}`);
                    const updatedDays = calculateDays(data.timestamp, newDate);
                    if (daysElement) {
                        daysElement.textContent = updatedDays;
                    }
                });
                inspectedDateElement.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        e.target.blur();
                    }
                });
            }
            return rowFragment;
        }

        async function updateInspectedDate(docId, newDate) {
            if (!db) {
                console.error("Firestore is not initialized.");
                return;
            }

            try {
                const docRef = doc(db, `/artifacts/${appId}/public/data/inspectionForms`, docId);
                await updateDoc(docRef, {
                    inspectedDate: newDate
                });
                console.log(`Document ${docId} updated with new inspected date: ${newDate}`);
            } catch (e) {
                console.error("Error updating document:", e);
                if (e.code === 'permission-denied') {
                    document.getElementById('firestorePermissionDeniedModal').style.display = 'flex';
                }
            }
        }
        
        window.updateInspectedBy = async function(docId, newInspector) {
            if (!db) {
                console.error("Firestore is not initialized.");
                return;
            }
            try {
                const docRef = doc(db, `/artifacts/${appId}/public/data/inspectionForms`, docId);
                await updateDoc(docRef, {
                    inspectedBy: newInspector
                });
                console.log(`Document ${docId} updated with new inspector: ${newInspector}`);
            } catch (e) {
                console.error("Error updating document:", e);
                if (e.code === 'permission-denied') {
                    document.getElementById('firestorePermissionDeniedModal').style.display = 'flex';
                }
            }
        };

        window.updateStatus = async function(docId, newStatus) {
            if (!db) {
                console.error("Firestore is not initialized.");
                return;
            }
            try {
                const docRef = doc(db, `/artifacts/${appId}/public/data/inspectionForms`, docId);
                await updateDoc(docRef, {
                    status: newStatus
                });
                console.log(`Document ${docId} updated with new status: ${newStatus}`);
            } catch (e) {
                console.error("Error updating document:", e);
                if (e.code === 'permission-denied') {
                    document.getElementById('firestorePermissionDeniedModal').style.display = 'flex';
                }
            }
        };
        
        window.updateRemarks = async function(docId, newRemarks) {
            if (!db) {
                console.error("Firestore is not initialized.");
                return;
            }
            try {
                const docRef = doc(db, `/artifacts/${appId}/public/data/inspectionForms`, docId);
                await updateDoc(docRef, {
                    remarks: newRemarks
                });
                console.log(`Document ${docId} updated with new remarks.`);
            } catch (e) {
                console.error("Error updating document:", e);
                if (e.code === 'permission-denied') {
                    document.getElementById('firestorePermissionDeniedModal').style.display = 'flex';
                }
            }
        };
        
        window.confirmDelete = function(docId) {
            const modal = document.getElementById('deleteModal');
            const confirmBtn = document.getElementById('confirmDeleteBtn');
            confirmBtn.onclick = () => deleteForm(docId);
            modal.classList.remove('hidden');
        };

        window.deleteForm = async function(docId) {
            if (!db) {
                console.error("Firestore is not initialized.");
                return;
            }
            const modal = document.getElementById('deleteModal');
            modal.classList.add('hidden');
            try {
                const docRef = doc(db, `/artifacts/${appId}/public/data/inspectionForms`, docId);
                await deleteDoc(docRef);
                console.log(`Document ${docId} successfully deleted.`);
            } catch (e) {
                console.error("Error deleting document:", e);
                if (e.code === 'permission-denied') {
                    document.getElementById('firestorePermissionDeniedModal').style.display = 'flex';
                }
            }
        };

        window.toggleDetails = function(docId) {
            const detailRow = document.getElementById(`details-row-${docId}`);
            if (detailRow) {
                if (detailRow.classList.contains('hidden')) {
                    detailRow.classList.remove('hidden');
                } else {
                    detailRow.classList.add('hidden');
                }
            }
        };

        function getPurchaseTypeColor(type) {
            switch(type) {
                case 'purchases': return 'bg-blue-200 text-blue-800';
                case 'ucss': return 'bg-green-200 text-green-800';
                case 'postRepair': return 'bg-purple-200 text-purple-800';
                case 'janitorial': return 'bg-orange-200 text-orange-800';
                default: return 'bg-gray-200 text-gray-800';
            }
        }

        function getPurchaseTypeLabel(type) {
            switch(type) {
                case 'purchases': return 'Operations Purchase';
                case 'ucss': return 'UCSS Purchase';
                case 'postRepair': return 'Post Repair / Waste Material';
                case 'janitorial': return 'Janitorial Services';
                default: return 'N/A';
            }
        }
        
        function getRequirementLabel(req) {
            switch(req) {
                case 'salesInvoice': return 'Sales Invoice/Official Receipt';
                case 'approvedPurchase': return 'Approved Purchase Request';
                case 'specialOrder': return 'Special Order/Line Item Budget';
                case 'proofSurrender': return 'Proof of Surrendered Waste';
                case 'endorsementLetter': return 'Endorsement Letter';
                case 'approvedBudget': return 'Approved Budget Proposal';
                case 'others': return 'Others';
                default: return req;
            }
        }

        function exportToCsv() {
            const table = document.getElementById('formsContainer').querySelector('table');
            const rows = table.querySelectorAll('tr');
            let csv = [];

            // Add the institutional header, titles, and date range
            const institutionHeader = [
                "Republic of the Philippines",
                "Polytechnic University of the Philippines",
                "OFFICE OF EXECUTIVE VICE PRESIDENT",
                "Inspection Management Office"
            ];
            const reportTitle = document.querySelector('h2').textContent.trim();
            const reportSubtitle = document.querySelector('p.text-xl').textContent.trim();
            const dateRange = document.getElementById('dateRangeDisplay').textContent.trim();
            
            const headerContent = [
                ...institutionHeader.map(line => `"${line}"`),
                // Add commas to simulate centering for the report titles
                `,,,,,,"${reportTitle}"`,
                `,,,,,,"${reportSubtitle}"`,
                `,,,,,,"${dateRange}"`,
                "" // Add an empty line for separation
            ];

            csv.push(...headerContent);

            // Get table headers, excluding the last one (Actions)
            const headers = Array.from(rows[0].querySelectorAll('th')).slice(0, -1).map(th => th.textContent.trim());
            csv.push(headers.join(','));

            const costColumnIndex = headers.findIndex(header => header === 'Cost');

            // Get visible rows (main rows only), excluding the last cell (Actions)
            for (let i = 1; i < rows.length; i += 2) {
                const row = rows[i];
                const rowData = Array.from(row.querySelectorAll('td')).slice(0, -1).map((td, index) => {
                    let text = '';
                    if (td.querySelector('span.editable-field')) {
                        text = td.querySelector('span.editable-field').textContent.trim();
                    } else if (td.querySelector('select')) {
                        text = td.querySelector('select').value;
                    } else {
                        text = td.textContent.trim();
                    }

                    // For the Cost column, format to include commas and two decimal places
                    if (index === costColumnIndex) {
                        const cleanedText = text.replace(/₱/g, '').replace(/,/g, '');
                        const costValue = parseFloat(cleanedText);
                        if (!isNaN(costValue)) {
                            text = costValue.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                        } else {
                            text = '';
                        }
                    }

                    // Handle commas in data by wrapping in double quotes
                    if (text.includes(',')) {
                        return `"${text}"`;
                    }
                    return text;
                });
                csv.push(rowData.join(','));
            }

            const csvString = csv.join('\n');
            const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'inspection_monitoring_report.csv';
            link.style.display = 'none';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
</body>
</html>
